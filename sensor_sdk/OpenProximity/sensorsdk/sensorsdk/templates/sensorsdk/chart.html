{% extends "sensorsdk/base.html" %}
{% load i18n %}

{% block extrahead %}
    <script type="text/javascript" src="/site_media/MochiKit.js"></script>
    <script type="text/javascript" src="/site_media/swfobject.js"></script>
    <script type="text/javascript" src="/site_media/json2.js"></script>
    <script type="text/javascript">

    var charts=new Object;
    var last_chart = null;

    function findSWF(movieName) {
	if (navigator.appName.indexOf("Microsoft")!= -1) {
	    return window[movieName];
	} else {
	    return document[movieName];
	}
    }

    function create_chart(name, target, fields, span){
	so=swfobject.embedSWF(
	    "/site_media/open-flash-chart-full-embedded-font.swf", 
	    name, "100%", "400", "9.0.0","",
	    {
		'data-file': "/sensorsdk/API/get-chart-data/"+target+"/"+fields+"/data.json?span="+span
	    }
	    );
	last_chart=name;
	charts[name]=new Object;
	charts[name]['target']=target;
	charts[name]['fields']=fields;
	charts[name]['span']=span;
    }

    function update_chart(chart){
	var shared_data = "";
	
	url="/sensorsdk/API/get-chart-data/"+charts[chart].target+"/"+charts[chart].fields+"/data.json?span="+charts[chart].span;
	chart=$(chart)
	var d = loadJSONDoc(url);

	var gotData = function (data) {
	    chart.load(JSON.stringify(data));
	};

	var dataFetchFailed = function (err) {
	    alert("The data couldn't be fetched :(");
	};
	d.addCallbacks(gotData, dataFetchFailed);
    }
    
    function generic_update_list(url, id, display, sel_val, success){
	var d = loadJSONDoc(url);
	
	var gotData = function (data) {
	    control=$(id);
	    j = 0;
	    for (i in data){
		var v = Option(display(data[i]), sel_val(data[i]), false, false);
		control.options[j]=v;
		j++;
	    }
	    if (success != null){
		success();
	    }
	};

	var dataFetchFailed = function (err) {
	    //alert("The " + id + " data couldn't be fetched :(");
	};
	d.addCallbacks(gotData, dataFetchFailed);
    }
    
    function update_type_sensors_list(){
	generic_update_list(
	    "/sensorsdk/API/get-modes/", 
	    "node_type",
	    function (elem) { return elem },
	    function (elem) { return elem },
	    update_sensors_list);
    };

    function update_sensors_list(elem){
	control=$('node_type');
	url = "/sensorsdk/API/get-sensors/"+control.value;

	generic_update_list(
	    url, 
	    "node_address",
	    function (elem) { return elem.name + ' ' + elem.address },
	    function (elem) { return elem.address },
	    update_fields_list);
    };

    function update_fields_list(elem){
	control=$('node_address');
	url = "/sensorsdk/API/get-chart-fields/"+control.value;
	generic_update_list(
	    url, 
	    "node_fields",
	    function (elem) { return elem },
	    function (elem) { return elem },
	    null);
    };

    addLoadEvent(
	function(){
	    connect($('node_type'), "onchange", update_sensors_list);
	    connect($('node_address'), "onchange", update_fields_list);
	    update_type_sensors_list();
	}
    );
    
    function refresh_chart(elem){
	target=getNodeAttribute($(elem._src), 'extra');
	update_chart(target);
    };
    
    function delete_chart(elem){
	target=getNodeAttribute($(elem._src), 'extra');
	removeElement(target);
    };
    
    function get_time_span(){
    el=getElementsByTagAndClassName('input', null, $('time_span'))
    for (v in el){
	    if (el[v].checked==true)
		return el[v].value
	}
	return null
    }
    
    function add_chart(){
	address=$('node_address').value;
	span=get_time_span()
	
	control=$('node_fields');
	fields=Array();
	var count=0;
	for ( i=0; i <  control.options.length; i++ ){
	    if (control.options[i].selected){
		fields[count]=control.options[i].value;
		count++;
	    }
	}
	if (count==0){
	    alert("{% trans "You need to choose at least one field" %}");
	    return;
	}
	
	n=0
	for ( v in charts) {
	    n++;
	}
	
	holder=DIV({'id': 'chart_holder' + n});
	appendChildNodes($('charts_holder'), holder);
	
	chart=DIV({'id': 'chart' + n});
	
	refresh=BUTTON({'id': 'refresh'+n, 'innerHTML': '{% trans "Refresh" %}', 'extra': chart.id});
	del =BUTTON({'id': 'delete'+n,  'innerHTML': '{% trans "Delete" %}',  'extra': holder.id});
	
	connect(refresh, 'onclick', refresh_chart);
	connect(del, 'onclick', delete_chart);

	appendChildNodes(holder, chart);
	appendChildNodes(holder, P());
	appendChildNodes(holder, refresh);
	appendChildNodes(holder, del)
	create_chart(chart.id, address, fields, span);
	last_chart=chart.id;
    }
    
    </script>
{% endblock %}

{% block content %}

<table>
    <tr>
        <td>{% trans "Type" %}</td>
        <td><select size="1" id="node_type"></select></td>
    </tr>
    <tr>
        <td>{% trans "Node" %}</td>
        <td><select size="1" id="node_address"></select></td>
    </tr>
    <tr>
        <td>{% trans "Fields" %}</td>
        <td><select size="4" id="node_fields" multiple="multiple"></select></td>
    </tr>
    <tr>
	<td>{% trans "Time Span" %}</td>
	<td>
	    <form id="time_span">
	    <input type="radio" name="time_span" value="hour" checked>{% trans "Last Hour" %}</input>
	    <input type="radio" name="time_span" value="day">{% trans "Last Day" %}</input>
	    <input type="radio" name="time_span" value="week">{% trans "Last Week" %}</input>
	    <input type="radio" name="time_span" value="month">{% trans "Last Month" %}</input>
	    </form>
	</td>
</table>
<p></p>
<span>
    <button type="button" name="create_chart" id="create_chart" onclick="add_chart();">{% trans "Add Chart" %}</button>
    <button type="button" name="refresh" id="refresh">{% trans "Refresh Fields" %}</button>
</span>
<p></p>
<div id="charts_holder">
</div>
{% endblock %}
