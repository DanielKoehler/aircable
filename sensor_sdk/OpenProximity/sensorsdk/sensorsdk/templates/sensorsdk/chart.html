{% extends "sensorsdk/base.html" %}
{% load i18n %}

{% block extrahead %}
    <script type="text/javascript" src="/site_media/MochiKit.js"></script>
    <script type="text/javascript" src="/site_media/swfobject.js"></script>
    <script type="text/javascript" src="/site_media/json2.js"></script>
    <script type="text/javascript">

    var charts=new Object;
    var last_chart = null;
    
    function get_url(name){
	out = "/sensorsdk/API/get-chart-data/"+charts[name].target+"/"+fields+"/data.json?"+ queryString(charts[name])
	
	return out
    }

    function findSWF(movieName) {
	if (navigator.appName.indexOf("Microsoft")!= -1) {
	    return window[movieName];
	} else {
	    return document[movieName];
	}
    }

    function create_chart(name, target, fields, span, holder){
	charts[name]=new Object;
	charts[name]['target']=target;
	charts[name]['fields']=fields;
	charts[name]['span']=span;
	charts[name]['raw']=$('chart_raw').checked;
	charts[name]['smooth']=$('chart_smooth').checked;
	charts[name]['smooth_factor']=$('chart_smooth_factor').text

	swfobject.embedSWF(
	    "/site_media/open-flash-chart-full-embedded-font.swf", 
	    name, "100%", "400", "9.0.0","",
		{
		    "loading": "{% trans "Loading charts please wait..."%}",
		    "data-file": escape(get_url(name))
		}
	    );
	
	roundElement(holder);
	last_chart=name;
    }

    function update_chart(chart){
	var shared_data = "";
	
	url=get_url(chart);
	holder=findSWF(chart)
	holder.reload(url)
    }
    
    function generic_update_list(url, id, display, sel_val, success){
	var d = loadJSONDoc(url);
	
	var gotData = function (data) {
	    control=$(id);
	    control.options.length=0;
	    j = 0;
	    for (i in data){
		var v = Option(display(data[i]), sel_val(data[i]), false, false);
		control.options[j]=v;
		j++;
	    }
	    if (success != null){
		success();
	    }
	};

	var dataFetchFailed = function (err) {
	    //alert("The " + id + " data couldn't be fetched :(");
	    control=$(id);
	    control.options.length=0;
	};
	d.addCallbacks(gotData, dataFetchFailed);
    }
    
    function update_type_sensors_list(){
	generic_update_list(
	    "/sensorsdk/API/get-modes/", 
	    "node_type",
	    function (elem) { return elem },
	    function (elem) { return elem },
	    update_sensors_list);
    };

    function update_sensors_list(elem){
	control=$('node_type');
	url = "/sensorsdk/API/get-sensors/"+control.value;

	generic_update_list(
	    url, 
	    "node_address",
	    function (elem) { return elem.friendly_name + ' - '  + elem.name + ' ' + elem.address },
	    function (elem) { return elem.address },
	    update_fields_list);
    };

    function update_fields_list(elem){
	control=$('node_address');
	url = "/sensorsdk/API/get-chart-fields/"+control.value;
	generic_update_list(
	    url, 
	    "node_fields",
	    function (elem) { return elem },
	    function (elem) { return elem },
	    null);
    };

    addLoadEvent(
	function(){
	    connect($('node_type'), "onchange", update_sensors_list);
	    connect($('node_address'), "onchange", update_fields_list);
	    update_type_sensors_list();
	}
    );
    
    function refresh_chart(elem){
	target=getNodeAttribute($(elem._src), 'extra');
	update_chart(target);
    };
    
    function delete_chart(elem){
	target=getNodeAttribute($(elem._src), 'extra');
	removeElement(target);
    };
    
    function get_time_span(){
    el=getElementsByTagAndClassName('input', null, $('time_span'))
    for (v in el){
	    if (el[v].checked==true)
		return el[v].value
	}
	return null
    }
    
    function add_chart(){
	address=$('node_address').value;
	span=get_time_span()
	
	control=$('node_fields');
	fields=Array();
	var count=0;
	for ( i=0; i <  control.options.length; i++ ){
	    if (control.options[i].selected){
		fields[count]=control.options[i].value;
		count++;
	    }
	}
	if (count==0){
	    alert("{% trans "You need to choose at least one field" %}");
	    return;
	}
	
	n=0
	for ( v in charts) {
	    n++;
	}
	
	holder=DIV({'id': 'chart_holder' + n, 'class': 'content-main'});
	inner=DIV({'class': 'inner', 'style':'padding: 1em;'})
	appendChildNodes($('charts_holder'), holder);
	appendChildNodes(holder, inner);
	chart=DIV({'id': 'chart' + n});
	
	refresh=BUTTON({'id': 'refresh'+n, 'innerHTML': '{% trans "Refresh" %}', 'extra': chart.id});
	del =BUTTON({'id': 'delete'+n,  'innerHTML': '{% trans "Delete" %}',  'extra': holder.id});
	
	connect(refresh, 'onclick', refresh_chart);
	connect(del, 'onclick', delete_chart);

	appendChildNodes(inner, chart);
	appendChildNodes(inner, P());
	appendChildNodes(inner, refresh);
	appendChildNodes(inner, del)
	create_chart(chart.id, address, fields, span, holder);
	last_chart=chart.id;
    }
    
    
    
    </script>
{% endblock %}

{% block content %}
<div class="content-main">
<div class="inner">
<table>
    <tr>
        <td>{% trans "Type" %}</td>
        <td><select size="1" id="node_type"></select></td>
    </tr>
    <tr>
        <td>{% trans "Node" %}</td>
        <td><select size="1" id="node_address"></select></td>
    </tr>
    <tr>
        <td>{% trans "Fields" %}</td>
        <td><select size="4" id="node_fields" multiple="multiple"></select></td>
    </tr>
    <tr>
	<td>{% trans "Time Span" %}</td>
	<td>
	    <form id="time_span">
	    <input type="radio" name="time_span" value="hour" checked>{% trans "Last Hour" %}</input>
	    <input type="radio" name="time_span" value="day">{% trans "Last Day" %}</input>
	    <input type="radio" name="time_span" value="week">{% trans "Last Week" %}</input>
	    <input type="radio" name="time_span" value="month">{% trans "Last Month" %}</input>
	    </form>
	</td>
    </tr>
    <tr>
	<td>{% trans "Options" %}</td>
	<td>
	    <input type="checkbox" id="chart_raw" checked>{% trans "Raw Data" %}</input>
	    <input type="checkbox" id="chart_smooth">{% trans "Smooth Data" %}</input>
	    {% trans "Smooth Factor" %}:<input type="text" id="chart_smooth_factor" value="0.2" />
	</td>
    </tr>
</table>
<p></p>
<span>
    <button type="button" name="create_chart" id="create_chart" onclick="add_chart();">{% trans "Add Chart" %}</button>
    <button type="button" name="refresh" id="refresh">{% trans "Refresh Fields" %}</button>
</span>
<p></p>
</div>
</div>
<div id="charts_holder">
</div>
{% endblock %}
